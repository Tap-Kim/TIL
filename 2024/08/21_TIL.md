# 브라우저 로드시 HTML 성능을 위한 5가지 일반적인 고려사항

## 정리

- 리다이렉트를 최소화하여 영구 리다이렉션(301) 또는 일시적 리다이렉션(302) 응답을 활용하자
- `Etag`, `Cache-Control`를 활용하여 HTML 브라우저 캐싱을 제어하자
- `Server-Timing`을 활용하여 서버사이드 응답시 TTFB를 최적화하자
- `Brotli`, `gzip`을 활용하여 파일 리소스를 줄이고, 동적/정적 압축을 구분하여 최적화하자
- `CDN`을 활용하여 엣지 서버에 리소스를 물리적으로 제공하여 왕복시간(RTT)를 줄이는 동시에 캐싱, 압축을 활용하여 TTFB를 개선하자.

### 참고

- 주요 키워드:
- 관련 기술:

## 무엇을 알았는지

일반적으로 웹 사이트를 브라우저에서 호출하기 위해서 GET 요청을 통해 HTML에 대한 응답을 받게 된다. 이는 웹 사이트에서 페이지를 요청하기 위한 가장 첫 번째 단계이고, 이때의 리소스를 최소한의 지연으로 제어하는 것이 좋은 성능을 가지게 된다.

이는 단계별 소요 시간을 단축할 수 있으며 첫 번째 바이트인 TTFB가 있다.

TTFB가 유일한 측정항목은 아니지만 TTFB가 높으면 페이지 로드 속도를 높여 '우수'로 지정된 측정항목에는 최대 콘텐츠 렌더링 시간(LCP)와 콘텐츠가 포함된 첫 페인트(FCP)를 개선할 수 있다.

#### Redirection 최소화

리소스 요청시 서버는 리다이렉션에 응답할 수 있으며, `영구 리다이렉션`(`301` Moved Permanently 응답) 또는 `일시적 리다이렉션`(`302` Found 응답)이 있다.

1. 원본 출처 내에서만 발생하는 _Same-origin redirects_. 이는 관리 로직이 전적으로 웹 서버에 있으므로 사용자가 제어할 수 있다.
2. 다른 출처에서 시작된 _Cross-origin redirects_. 이는 일반적으로 관리자가 통제할 수 없다.

*Cross-origin redirects*은 주로 광고, URL 단축 서비스(bitly), 서드 파티 서비스에 대한 액세스 권한을 제공한다.

#### HTML 응답 캐시

응답에는 중요 리소스인 CSS, Javascript, 이미지, 기타 리소스가 있다. 이 리소스에는 각 인스턴스에 고유한 fingerprint가 포함될 수, 파일 이름을 기반으로 한다. 파일 내용에 따라 변경됨. 즉, 캐시된 HTML 문서는 오래된 하위 리소스에 대한 참조를 포함하므로 배포 후 오래된 문서가 될 수 있다.

그렇지만 캐싱을 사용하지 않고 짧은 캐시 수명을 사용하면 이점을 가질수 있다.

예를 들어 리소스가 CDN에서 캐시되도록 허용하여 요청을 보내고 원본 서버와 브라우저에서 리소스를 다시 다운로드하는 대신 재검증을 해야하기 때문에 맥락에 상관없이 변하지 않는 `정적 콘텐츠`에 적합하고, 리소스 캐시 시간은 분 단위로 설정 가능하다. 정적 HTML 리소스는 5분만 투자해도 괜찮고 정기 업데이트를 자주하지 않는 것이다.

페이지의 HTML 콘텐츠가 인증된 사용자와 같이 어떤 방식으로든 개인화된 경우 보안 및 새로 고침 등 다양한 우려로 인해 콘텐츠를 전혀 캐시하지 않을 가능성이 높다. 이때는 경우에 따라 HTML 캐싱을 피하는 것이 가장 좋다.

HTML 캐싱의 경우 `ETag`(요청된 리소스를 고유하게 나타내는 식별자) 또는 `Last-Modified` 응답 헤더를 사용한다.

```sh
ETag: "33a64df551425fcc55e4d42a148795d9f25f89d4"
```

리소스가 변경될 때마다 `Etag` 값을 생성해야하고, 서버의 `Etag`가 일치하는 경우 전송된 서버는 `304` Not Modified를 응답하여 브라우저에선 캐시 리소스를 사용한다.

#### 서버 응답 시간 측정

응답 캐싱이 되지 않은 경우 호스팅 또는 백엔드 스택에 최적화 되어있다. 웹 페이지의 동적 생성으로 응답되는 응답(예: DB 데이터 요청)을 위해 정적 페이지보다 TTFB가 높을 수 있지만 즉각적인 반응이 가능하다. (스피너와 같은 대체 화면)

이때 사용자의 화면에서 느린 TTFB가 발생하는 경우 정보를 `Server-Timing`을 사용하여 노출할 수 있다.

```sh
Server-Timing: auth;dur=55.5, db;dur=220
```

- 사용자 인증 시간 (auth)으로 55.5밀리초가 소요되었습니다.
- 220밀리초가 소요된 데이터베이스 액세스 시간 (db)

#### 압축

CSS, Javascript, 이미지와 같은 텍스트 기반 응답은 전송 크기를 줄이기 위해 압축된 형태로 다운로드할 수 있는데 가장 많이 알려진 알고리즘은 gzip과 Brotli이다. Brotli 를 사용하면 gzip에 비해 파일 속도가 약 15~20% 개선된다.

1. 가능하면 Brotli를 사용(?): gzip에 비해 크게 개선되었지만 모든 브라우저에선 제공이 안된다. 범용적으로 쓰려면 gzip을 쓸것
2. 파일 크기가 중요: 매우 작은 리소스(1KiB 미만)는 압축하지 않음 또는 때로는 전혀 압축하지 않는 것이 낫다. 데이터를 압축하고 비트를 찾는 압축 알고리즘을 작동시기는 리소스가 있기 때문이다. 하지만 파일이 클수록 압축이 더 잘 작동되고 효과적이다(Javascript, css 같은 대규모 리소스는 로드 완료 후 파싱 및 평가에 압축 해제 되어 더 자주 변경된다. 약간만 변경되어도 파일 해시가 달라짐)
3. 동적 압축과 정적 압축의 차이를 이해하자: 동적 및 정적 압축은 리소스가 배포되어야 하는 시점에 대한 다른 접근 방식이다. 정적 압축은 서버 응답에 추가도리 수잇는 압축 자체와 관련된 지연시간을 단축할 수 있다.(Javascript, CSS, SVG 이미지는 정적 압축)

#### CDN

CDN은 원본 서버에서 리소스를 캐시하여 엣지 서버에서 리소스를 제공하여 물리적으로 사용자와 가까이 있는 서버이다. 따라서 RTT를 줄이고, 캐싱, 압ㅊ구을 통해 사용자에게 더욱 빠른 콘텐츠를 제공하기 때문에 TTFB를 크게 개선이 가능하다.

### 출처

- [일반적인 HTML 성능 고려사항](https://web.dev/learn/performance/general-html-performance)
