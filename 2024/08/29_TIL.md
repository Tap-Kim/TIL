# 웹 폰트 최적화

## 정리

- 웹 폰트 또한 로드 시간과 렌더링 시간에 있어서 페이지 성능에 영향을 미치게된다. 폰트 크기에 따라 FCP의 영향을 끼치게되고, `font-display` 같은 페이지의 CLS에 영향이 있는 레이아웃 이동이 일으킬수 있다. 따라서 상황에 따라 CSS가 불필요한 웹 폰트를 검색하는 것을 방지하는 것을 이해해야한다.
- `preload, inline @font-face 선언, 폰트 호스팅, WOFF2, 렌더링 방식`에 따라 폰트를 최적화하는 방법이 여러가지 존재한다.
- 앞선 모든 웹 리소스 최적화에서 공부했듯이 폰트도 마찬가지로 세부적으로 다운로드하는 시점, preload, 특정 확장자. 옵션에 따른 렌더링 방식에 따라 사용자에게 먼저 노출할 것인지, FOIT(Flash of Invisible Text)를 방지할 것인지, 다른 리소스 다운로드의 대역폭에 영향을 줄것인지를 세부적으로 선택해서 최적화가 가능하다.

### 참고

- 주요 키워드: font, rendering block, hosting, crossorigin, CSS, CLS, LCP, FOIT
- 관련 기술: css

## 무엇을 알았는지

```css
@font-face {
  font-family: "Open Sans";
  src: url("/fonts/OpenSans-Regular-webfont.woff2") format("woff2");
}

h1 {
  font-family: "Open Sans";
}
```

폰트는 `@font-face`를 선언을 통해 스타일 시트에 정의된다. 위 css는 `font-family`를 "Open Sans"로 정의하고 브라우저에 폰트 리소스를 찾을 위치를 알려준다. 이는 대역폭을 보존하기 위해 현재 페이지에서 레이아웃에 필요하다고 판단될 때까지 폰트를 다운로드하지 않는다. 브라우저의 HTML에서 `<h1>` 요소를 파싱할때 "Open Sans"를
다운로드한다. 즉, CSSOM이 구축되고나서 폰트 다운로드를 진행한다.

### `preload`

`@font-face` 선언이 외부 스타일 시트에 정의된 경우 브라우저는 스타일 시트를 다운로드한 후 폰트 다운로드를 시작할 수 있다. 이는 폰트를 늦게 발견되는 리소스이며, `preload`를 사용하여 빠르게 받을 수 있다. 이는 브라우저에서 스타일 시트가 다운로드 및 파싱을 마칠 때까지 기다리지 않고 즉시 다운로드한다.

```html
<!-- 폰트는 CORS 리소스로 간주되므로 자체 호스팅 폰트을 포함하여, 폰트는 `crossorigin` 속성이 필요하다. -->
<link
  rel="preload"
  as="font"
  href="/fonts/OpenSans-Regular-webfont.woff2"
  crossorigin
/>
```

> 참고: 앞선 최적화에서도 `preload` 지시어는 신중하게 사용해야하며, 과도한 대역폭을 분산시킬 수 있따. 또한 CORS인 점도 유의해야하는데 자체 호스팅인 경우에도 마찬가지다.

### 인라인 `@font-face` 선언

<
`<style>` 요소를 사용해서 HTML의 `<head>`에 `@font-face` 선언을 포함한 렌더링 차단 CSS를 삽입하면 페이지 로딩 중에 글꼴을 더 빨리 로드할 수 있따. 이 경우 브라우저는 외부 스타일 시트가 다운로드될 때까지 기다릴 필요가 없어 초기에 폰트 검색을 한다. 이는 힌트를 사용하는 것보다 유리한데 브라우저는 현재 페이지를 렌더링 하는데 필요한 글꼴만 다운로드하기 때문. 따라서 사용하지 않는 글꼴을 다운로드할 가능성이 없다.

> 참고: 브라우저는 모든 렌더링 차단 리소스가 로드된 후에 글꼴 파일을 다운로드한다. 즉, `@font-face`를 인라인 선언해도 나머지 CSS가 외부 스타일에 있는 경우는 다운로드 될 때까지 기다려야한다.

> `중요`: 폰트 파일 자체를 CSS나 다른 리소스에 인라인으로 삽입하는 것은 좋지 않다. 그러면 필요한 base64 인코딩 체계로 인해 payload가 더 커지고 인라인으로 삽입하면 preload 스캐너가 지연되어서 다른 중요한 리소스를 검색하는데 시간이 더 많이 걸리기 때문이다.

### 다운로드

#### 폰트 `자체 호스팅`

폰트는 Google Fonts와 같이 타사 서비스를 통해 제공되거나 원본 자체에서 호스팅될 수 있다. 타사 서비스 사용시 폰트 다운로드 전 공급자의 도메인에 대한 연결을 열어야 폰트 검색 및 후속 다운로드가 지연될 수 있다.

이 오버헤드는 `preconnect` 힌트를 통해 줄일 수 있고 일반적으로 `preconnect`하는 것 보다 더 빨리 cross-origin에 대한 연결을 지시할 수 있다.

```html
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
```

앞의 HTML은 브라우저에 `font.googleapis.com`에 대한 연결과 `fonts.gstatic.com`에 대한 CORS 연결을 설정한다. Google 폰트와 같은 일부 업체는 서로 다른 출처의 CSS 및 폰트를 제공하기 때문이다.

또는 폰트를 `자체 호스팅`하게되면 CORS 연결이 필요 없다. 대부분 자체 호스팅이 crossorigin해서 다운로드하는 것보다 빠르다. 자체 호스팅 사용시 `CDN, HTTP/2, HTTP/3`를 사용하는지 확인하고 올바른 캐싱 헤더를 설정하자.

### `WOFF2` 사용하자.

[WOFF2](https://www.w3.org/TR/WOFF2/)는 광범위한 브라우저 지원과 최고의 압축률을 자랑한다. WOFF보다 30% 더 좋으며 다운로드 시간이 더 빠르다.

> 참고: WOFF, EOT, TTF와 같은 형식을 사용하는 유일한 이유는 레거시 브라우저를 지원할 경우 뿐이다.

### 폰트를 하위 집합으로 지정

폰트에는 일반적으로 다양한 [글리프](https://en.wikipedia.org/wiki/Glyph)가 포함되어있다. 이는 다양한 언어에 사용되는 다양한 문자를 표현하는데 필요하다. 페이지에서 하나의 언어로만 컨텐츠를 제공하거나 단일 알파벳을 사용하는 경우 하위 집합을 통해 폰트 크기를 줄일 수 있다.

예를 들어 *라틴 알파벳*만 사용하는 *Roboto 폰트*가 있는 *구글 폰트*를 제공한다면 이렇게 사용한다.

> `https://fonts.googleapis.com/css?family=Roboto&subset=latin`

폰트를 직접 호스팅시 [glyphhanger](https://github.com/zachleat/glyphhanger)나 [subfont](https://github.com/Munter/subfont)와 같은 도구를 사용해 하위 세트를 직접 생성하고 호스팅한다. 폰트를 자체 호스팅할 용량이 없는 경우 `text` 웹사이트에 필요한 유니코드 코드 포인트만 포함하는 쿼리 문자열 매개변수를 지정해서 구글 폰트에서 제공하는 폰트를 하위 집합으로 나눌수 있다.

예를 들어 *"Welcome"의 문구*에만 필요한 소수의 문자만 필요한 경우 이와 같이 극단적으로 하위 집합으로 사용할 수 있다.

> `https://fonts.googleapis.com/css?family=Monoton&text=Welcome`

### 폰트 렌더링

기본적으로 브라우저는 다운로드될 때까지 폰트를 사용하는 모든 텍스트의 렌더링을 차단한다. CSS 속성을 사용해서 텍스트 렌더링을 조정하고 폰트가 완전히 로드될 때까지 `font-display`를 통해 표시할 텍스트나 표시하지 않을 텍스트를 구성할 수 있다.

#### block

`font-display`의 기본값은 `block`이다. 이는 지정된 폰트를 사용하는 모든 텍스트는 렌더링 차단이 된다. 브라우저마다 다르게 동작하는데 크로미움과 파이어폭스는 fallback을 사용하기 전에 최대 3초 동안 렌더링 차단을 하고 사파리는 폰트가 로드될 때까지 무기한 차단한다.

#### swap

`swap`이 가장 널리 알려진 `font-display` 값이다. 이는 렌더링을 차단하지 않고 지정된 폰트로 바꾸기전에 fallback에서 즉시 표시한다. 다운은 기다리지 않고도 컨텐츠를 즉시 표시할 수 있다.

다만 CSS에 지정된 fallback 폰트와 폰트의 줄 높이, 커닝 및 기타 폰트 메트릭 측면에서 크게 다를 경우 레이아웃 변경이 일어나 빠르게 로드하기 위해 `preload` 힌트를 사용하지 않거나 다른 폰트 값을 고려하지 않으면 CLS에 영향을 미칠 수 있다.

#### fallback

`fallback`은 `block`과 `swap` 사이의 절충안이다. `swap`과 달리 브라우저는 폰트의 렌더링을 차단하지만 대체 텍스트의 `swap`은 매우 짧은 기간동안만 차단한다. 그러나 `block`과 달리 차단 기간이 매우 짧다.

`fallback`을 사용하면 폰트가 빠르게 다운로드되는 경우 초기 렌더링에 폰트가 즉시 사용되는 빠른 네트워크에서 잘 작동할 수 있으나, 네트워카 느리다면 차단 기간이 지나고나서 대체 텍스트가 먼저 표기되고 폰트가 도착하면 텍스트가 교체된다.

#### optional

`optional`은 가장 엄격한 폰트 표시다. 100ms 이내에 다운로드되는 경우에만 폰트 리소스를 사용한다. 그보다 오래 걸리면 브라우저는 폰트가 백그라운드에서 다운로드되어 브라우저 캐시에 저장되는 동안 현재 탐색에 대체 폰트를 사용한다. 결과적으로는 후속 페이지 탐색에서는 다운로되한 폰트 사용이 가능하다.

### 출처

- [optimize-web-fonts](https://web.dev/learn/performance/optimize-web-fonts)
