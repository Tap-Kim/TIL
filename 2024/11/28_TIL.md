# 현시점에서 이벤트루프의 우선순위는 어떤 기준으로 작업할까?

## 동시성과 병렬성

동시성(Concurrency)와 병렬성(Parallelism)에 대해서는 [동시성, 병렬성과 자바스크립트의 이해](https://github.com/Tap-Kim/TIL/blob/main/2024/11/15_TIL.md)에서 자세하게 다뤘지만, 간단히 이야기하면

- 동시성: 동시에 실행되는 것 처럼 보이게 컨텍스트 스위칭일 일어나는 상태
- 병렬성: 실제로 여러 작업이 동시에 처리되는 멀티 스레딩 상태

자바스크립트는 `싱글 스레드` 즉 코어가 하나인 CPU를 사용하며, 기본적으로 병렬성을 구성하지 못하는 구조다.

하지만 로직 수행, 네트워크 요청, UI 업데이트 명령등 많은 작업이 필요한데 이때 `동시성` 작업이 이루어진다.

그러면 이런 우선순위는 어떻게 선별하고 설계되는지 정리해보았다.

## 스케줄링, 우선순위

동시성으로 인해 다양한 작업을 순회하며 할당하는 작업으로 `스케줄링`이 이루어진다.

전체 작업 중에 더 빨리 실행되고, 늦게 실행되는 작업을 선별하고, 총 실행 시간, 스위칭 시간을 고려해서 목적에 맞게 우선순위를 배분해야한다.

그렇다면 어떤 목적에 따라 만들어야 할까?

## 마이크로테스크, 매크로 테스크, requestAnimationFrame

먼저 실행 우선순위는 **마이크로테스크 -> requestAnimationFrame -> 매크로 테스크** 순으로 실행된다.

### why?

브라우저가 무슨일을 주로할까? CPU 스케줄링 처럼 동시성을 구현함으로써 얻을 `목적`을 이해해야한다.

브라우저가 하는 일 중

1. 사용자에게 완성된 화면을 보여주어야한다.
2. 초기에 완성된 화면을 업데이트하여 다시 보여주어야한다.
3. 자바스크립트 실행시 1번은 제외된다.

즉, 브라우저가 하는 가장 중요한 일은 `업데이트된 화면을 보여주는 것`이다.

- Microtask Queue: Promise와 Mutation Observer가 해당 작업에 속한다.
- requestAnimationFrame: 브라우저가 **리페인트 전**, 애니메이션을 업데이트할 지정될 함수를 호출하도록 요청하는 것.
- Macrotask Queue: setTimeout. setInterval이 해당 작업에 속한다.

## 중요한 것

> 사용자 액션에 따라 업데이트된 화면을 보여줄때 가장 중요한것은?

`보여준다`는 의미에서 requestAnimationFrame 작업이 우선순위가 높은 것 같지만, `업데이트된`을 생각하자.

- `업데이트`: 화면 업데이트는 동기적으로 느껴질 수 있으나, 서버 데이터나 timeout 후 변경되어야할 작업 처럼 `비동기 작업`이 속할 수 있다.
- `된`: 작업이 끝난 것. 즉, 최신의 데이터를 가져오는 것을 끝내고 화면을 그려야(업데이트) 사용자는 문제없이 제대로된 데이터를 보게 된다. 만약 업데이트 우선순위보다 그리는 우선순위가 높다면?
  비동기 업데이트 경우 최신 데이터가 아닐때, 브라우저는 화면을 그리면 유저가 보는 화면에 문제가 생길 것이다. 한번 더그려야하는 것이다.

즉, `그리는 것(requestAnimationFrame)` 보다 `업데이트(Microtasck)`의 우선순위가 높다라는 말이다.
또한 자연스럽게 그리는 것도, 업데이트라고 보기 어려운 `Macrotask`는 자연스럽게 우선순위가 낮아진다.

## 정리

`업데이트된`를 의미하는 `Microtask`의 우선순위가 가장 높고, `보여준다`를 의미하는 `requestAnimationFrame`이 다음이고, 마지막으로 목적과 거리가 먼 `Macrotask`가 우선순위가 가장 낮아진다.

문제 check

1. 무한히 많은 `Microtask`가 있다면, `Macrotask`는 strave 상태에 빠질 수 있다.
2. 무한 재귀를 가진 `requestAnimationFrame`이 있어도, 리페인팅 시점 직전에 `1회` 실행되는 것이 보장된다. 따라서 `requestAnimationFrame`은 `Macrotask`를 블락시킬 수 없다.

## 참고

-[웹 브라우저 이벤트루프는 왜 그런 우선순위로 작업을 실행시킬까 (feat. CPU 스케줄링)](https://0422.tistory.com/374#google_vignette)
